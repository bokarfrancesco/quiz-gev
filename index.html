<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Quiz GEV Legambiente Reggio Emilia</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<!-- Icone Apple -->
<link rel="apple-touch-icon" sizes="192x192" href="quiz_icona_192.png">
<link rel="apple-touch-icon" sizes="512x512" href="quiz_icona_512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Quiz GEV">
<meta name="theme-color" content="#3498db">

<style>
body{font-family:Arial,sans-serif;font-size:clamp(14px,2.5vw,18px);background:#f2f2f2;margin:0;padding:10px;color:#333;}
header{text-align:center;margin-bottom:15px;}
header img{max-height:80px;display:block;margin:0 auto 10px;}
h2{color:#2c3e50;font-size:clamp(1.5em,4vw,2em);margin:5px 0;text-align:center;}

.quiz-button, .submit-btn, #nextBtn, #prevBtn {
    padding: clamp(10px,2.5vw,14px);
    font-size: clamp(16px,3vw,20px);
    border: none;
    border-radius: 10px;
    cursor: pointer;
}
.quiz-button{background:#3498db;color:white;} 
.quiz-button:hover{background:#2980b9;}
.submit-btn{background:#27ae60;color:white;} 
.submit-btn:hover,#nextBtn:hover,#prevBtn:hover{background:#1e8449;}

.question-box{background:white;border-radius:8px;padding:10px 15px;margin:8px 0;line-height:1.4em;word-wrap:break-word;}
.question-box b{display:block;margin-bottom:8px;font-size:clamp(1em,2.5vw,1.1em);}
.option{margin:6px 0;font-size:clamp(0.9em,2.5vw,1.1em);padding:clamp(8px,2vw,12px);border-radius:6px;border:1px solid #ccc;display:block;cursor:pointer;background:#fafafa;}
.option:hover{background:#e6f0ff;}

#feedbackContainer{background:#ecf0f1;border-radius:10px;padding:12px;margin-top:15px;}
#feedbackContainer p.message{font-weight:bold;font-size:clamp(1em,2.5vw,1.2em);color:#27ae60;margin-top:10px;}
#infoMessage{background:#dff0d8;border-radius:8px;padding:10px;margin:8px 0;color:#3c763d;font-weight:bold;text-align:center;}
.progress-bar{height:15px;background:#27ae60;border-radius:8px;margin:10px 0;width:0%;transition:width 0.3s;}

.button-container { display:flex; justify-content:space-between; margin-top:10px; max-width:350px; margin-left:auto; margin-right:auto; gap:10px;}
.button-container.center { justify-content:center; }
.button-container button { flex:1; margin:0 5px; }

/* Landscape: pulsanti più grandi */
@media (orientation: landscape) {
    .quiz-button, .submit-btn, #nextBtn, #prevBtn {padding:16px 20px; font-size:22px;}
    body{padding:5px;}
    .question-box{font-size:clamp(12px,2vw,16px);}
}
</style>
</head>
<body>

<header>
  <img src="quiz_icona_192.png" alt="Legambiente Reggio Emilia">
  <h2>Quiz GEV WebApp Legambiente Reggio Emilia</h2>
</header>

<div style="text-align:center;">
  <button class="quiz-button" onclick="startQuiz('completo')">Test Completo</button>
  <button class="quiz-button" onclick="startQuiz('semplificato')">Test Semplificato</button>
</div>

<hr>
<div id="infoMessage"></div>
<div id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
<div id="quizContainer"></div>
<div id="feedbackContainer"></div>

<script>
let currentMode="", currentQuestions=[], currentIndex=0, userAnswers=[];

function startQuiz(mode){
  currentMode=mode; currentIndex=0; userAnswers=[];
  document.getElementById("infoMessage").innerHTML="Caricamento domande...";
  document.getElementById("feedbackContainer").innerHTML="";
  document.getElementById("progressBar").style.width="0%";
  google.script.run.withSuccessHandler(data=>{
    if(data.error){alert(data.error);return;}
    currentQuestions=data.questions;
    document.getElementById("infoMessage").innerHTML=data.infoMessage;
    renderQuestion();
  }).getQuestions(mode);
}

function renderQuestion(){
  const container=document.getElementById("quizContainer"); container.innerHTML="";
  if(currentIndex>=currentQuestions.length) return;

  const q=currentQuestions[currentIndex];
  let div=document.createElement("div"); div.className="question-box";
  div.innerHTML=`<b>${q.question}</b>` + q.options.map(opt=>`<label class="option"><input type="radio" name="q" value="${opt}"> ${opt}</label>`).join("");
  container.appendChild(div);

  const btnContainer=document.createElement("div"); btnContainer.className=(currentIndex===0||currentIndex===currentQuestions.length-1)?"button-container center":"button-container";

  if(currentIndex>0){ let prevBtn=document.createElement("button"); prevBtn.innerText="Indietro"; prevBtn.onclick=prevQuestion; btnContainer.appendChild(prevBtn);}
  let nextBtn=document.createElement("button"); 
  nextBtn.innerText=(currentIndex===currentQuestions.length-1)?"Termina e Invia":"Avanti";
  nextBtn.onclick=(currentIndex===currentQuestions.length-1)?showResults:nextQuestion;
  btnContainer.appendChild(nextBtn);

  container.appendChild(btnContainer);
  document.getElementById("progressBar").style.width=(currentIndex/currentQuestions.length*100)+"%";
}

function nextQuestion(){ saveAnswer(); currentIndex++; renderQuestion();}
function prevQuestion(){ saveAnswer(); currentIndex--; renderQuestion();}
function saveAnswer(){
  const selected=document.querySelector('input[name="q"]:checked');
  userAnswers[currentIndex]=selected?selected.value:"";
}
function showResults(){
  saveAnswer();
  const emailField=document.getElementById("emailField");
  const email=emailField?emailField.value:"";
  google.script.run.withSuccessHandler(showFeedback).submitAttempt({answers:userAnswers,questions:currentQuestions,email,mode:currentMode});
}

function showFeedback(data){
  if(data.error){alert(data.error);return;}
  let html="<h3>Feedback:</h3>";
  data.feedback.forEach(f=>html+=`<div class="question-box"><b>${f.question}</b>Risposta corretta: <b>${f.correct}</b><br>Tua risposta: ${f.userAnswer||"(nessuna)"}<br>${f.isCorrect?"✅ Corretto":"❌ Sbagliato"}</div>`);
  html+=`<b>Punteggio:</b> ${data.correctCount}/${currentQuestions.length}<br>`;
  html+=`<p class="message">${data.message}</p>`;
  html+='<button class="quiz-button" onclick="startQuiz(currentMode)">Ripeti Test</button>';
  document.getElementById("quizContainer").innerHTML="";
  const fc=document.getElementById("feedbackContainer"); fc.innerHTML=html;
  fc.scrollIntoView({behavior:"smooth"});
  document.getElementById("progressBar").style.width="100%";
}
</script>

</body>
</html>
